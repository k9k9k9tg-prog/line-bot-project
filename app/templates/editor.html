<!DOCTYPE html>
<html lang="ja" data-bs-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>シナリオエディタ</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">
<link rel="stylesheet" href="/static/sidebar.css">
<style>
  .CodeMirror {
    border: 1px solid #495057;
    border-radius: 0.375rem;
    height: 100%;
  }
  .content main {
    height: calc(100vh - 2rem); /* padding分を引く */
  }
  .main-editor-card {
    height: 60%;
  }
  .ai-card {
    height: 40%;
  }
</style>
</head>
<body>

<div class="sidebar">
  <h1 class="sidebar-header">LINE Bot</h1>
  <ul class="nav flex-column">
    <li class="nav-item"><a href="/admin" class="nav-link">管理画面</a></li>
    <li class="nav-item"><a href="/operator" class="nav-link">オペレーター</a></li>
    <li class="nav-item"><a href="/editor" class="nav-link active">シナリオエディタ</a></li>
  </ul>
</div>

<div class="content">
  <main class="p-3 d-flex flex-column">
    <!-- Main Editor -->
    <div class="card shadow-sm d-flex flex-column main-editor-card mb-3">
      <div class="card-header d-flex align-items-center">
        <label for="scenario-select" class="form-label mb-0 me-2">シナリオ:</label>
        <select id="scenario-select" class="form-select w-auto"></select>
        <button id="add-scenario" class="btn btn-sm btn-success ms-2">新規</button>
        <button id="delete-scenario" class="btn btn-sm btn-danger ms-1">削除</button>
        <div class="ms-auto d-flex align-items-center">
          <input type="file" id="import-file" class="d-none">
          <button id="import-scenario" class="btn btn-sm btn-outline-info">インポート</button>
          <button id="export-scenario" class="btn btn-sm btn-outline-info ms-2">エクスポート</button>
          <button id="save-scenario" class="btn btn-primary ms-3">保存</button>
        </div>
      </div>
      <div class="card-body flex-grow-1 p-2">
        <textarea id="json-editor"></textarea>
      </div>
    </div>

    <!-- AI Generator -->
    <div class="card shadow-sm d-flex flex-column ai-card">
      <h5 class="card-header">AIアシスタント</h5>
      <div class="card-body d-flex flex-column">
        <textarea id="ai-prompt" class="form-control flex-grow-1" placeholder="例: ユーザーに名前を聞いて、次に用件を聞くシナリオを作って。"></textarea>
      </div>
      <div class="card-footer text-end">
        <button id="generate-with-ai" class="btn btn-info">
          <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          AIで生成
        </button>
      </div>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
<script>
let scenarios = {};
let editor;

// --- CodeMirrorの初期化 ---
function initializeEditor() {
  editor = CodeMirror.fromTextArea(document.getElementById('json-editor'), {
    mode: { name: "javascript", json: true },
    theme: "dracula",
    lineNumbers: true,
    autofocus: true
  });
  editor.setSize("100%", "100%");
}

// --- シナリオデータの操作 ---
function loadScenarioToEditor(name) {
  if (scenarios[name]) {
    const formattedJson = JSON.stringify(scenarios[name], null, 2);
    editor.setValue(formattedJson);
  }
}

function updateScenarioSelect() {
  const select = document.getElementById("scenario-select");
  const currentVal = select.value;
  select.innerHTML = "";
  Object.keys(scenarios).forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
  });
  select.value = currentVal && scenarios[currentVal] ? currentVal : Object.keys(scenarios)[0];
}

// --- イベントリスナー ---
document.addEventListener("DOMContentLoaded", () => {
  initializeEditor();

  fetch("/get_scenarios")
    .then(r => r.json())
    .then(data => {
      scenarios = data;
      updateScenarioSelect();
      const initialScenario = document.getElementById("scenario-select").value;
      if (initialScenario) {
        loadScenarioToEditor(initialScenario);
      }
    });

  document.getElementById("scenario-select").addEventListener("change", (e) => {
    loadScenarioToEditor(e.target.value);
  });

  document.getElementById("add-scenario").addEventListener("click", () => {
    const name = prompt("新しいシナリオ名を入力:");
    if (!name || scenarios[name]) {
      if (name) alert("その名前のシナリオは既に存在します。");
      return;
    }
    scenarios[name] = ["新しいメッセージ"];
    updateScenarioSelect();
    document.getElementById("scenario-select").value = name;
    loadScenarioToEditor(name);
  });
  
  document.getElementById("delete-scenario").addEventListener("click", () => {
    const select = document.getElementById("scenario-select");
    const nameToDelete = select.value;
    if (!nameToDelete || !confirm(`シナリオ「${nameToDelete}」を削除しますか？`)) return;
    
    delete scenarios[nameToDelete];
    updateScenarioSelect();
    const newCurrent = select.value;
    if (newCurrent) {
      loadScenarioToEditor(newCurrent);
    } else {
      editor.setValue(""); // シナリオが空になった場合
    }
  });

  document.getElementById("save-scenario").addEventListener("click", () => {
    const currentScenario = document.getElementById("scenario-select").value;
    if (!currentScenario) {
      alert("保存するシナリオが選択されていません。");
      return;
    }
    try {
      const updatedSteps = JSON.parse(editor.getValue());
      if (!Array.isArray(updatedSteps)) {
        throw new Error("JSONが配列ではありません。");
      }
      scenarios[currentScenario] = updatedSteps;

      fetch("/save_scenarios", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(scenarios)
      })
      .then(r => r.json())
      .then(d => {
        if (d.status === "ok") {
          alert("保存しました");
        } else {
          alert("保存に失敗しました: " + d.message);
        }
      });
    } catch (e) {
      alert("JSONの形式が正しくありません: " + e.message);
    }
  });

  // --- インポート・エクスポート機能 ---
  const importFile = document.getElementById('import-file');
  document.getElementById('import-scenario').addEventListener('click', () => importFile.click());
  importFile.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const importedData = JSON.parse(e.target.result);
        if (typeof importedData !== 'object' || importedData === null) throw new Error();
        scenarios = importedData;
        updateScenarioSelect();
        const firstScenario = Object.keys(scenarios)[0];
        if(firstScenario) {
            document.getElementById("scenario-select").value = firstScenario;
            loadScenarioToEditor(firstScenario);
        }
        alert('シナリオをインポートしました。');
      } catch (err) {
        alert('無効なJSONファイルです。');
      }
    };
    reader.readAsText(file);
    event.target.value = '';
  });

  document.getElementById('export-scenario').addEventListener('click', () => {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(scenarios, null, 2));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "scenarios.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
  });

  // --- AIアシスタント機能 ---
  const generateBtn = document.getElementById('generate-with-ai');
  const promptInput = document.getElementById('ai-prompt');
  const spinner = generateBtn.querySelector('.spinner-border');

  generateBtn.addEventListener('click', async () => {
    const prompt = promptInput.value.trim();
    if (!prompt) {
      alert('AIへの指示を入力してください。');
      return;
    }

    // UIをローディング状態に
    spinner.classList.remove('d-none');
    generateBtn.disabled = true;

    try {
      const response = await fetch('/generate_with_ai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: prompt })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'AIの応答がありません。');
      }

      const scenarioArray = await response.json();
      const formattedJson = JSON.stringify(scenarioArray, null, 2);
      editor.setValue(formattedJson);
      alert('シナリオが生成されました。内容を確認して保存してください。');

    } catch (e) {
      alert('エラー: ' + e.message);
    } finally {
      // UIを通常状態に戻す
      spinner.classList.add('d-none');
      generateBtn.disabled = false;
    }
  });
});
</script>
</body>
</html>
